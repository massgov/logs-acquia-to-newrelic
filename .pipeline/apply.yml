# This represents the "Plan" job for our CI pipeline.
#
# The "Plan" job will be run when code is pushed to a branch other than `develop` or `master`.
# This job operates with Read-Only IAM permissions, meaning you can see the state of resources, but not change them.
# The definition can be changed here to suit the individual project.
version: 0.2

cache:
  paths:
    - terraform/dist/*

phases:
  build:
    commands:
    - cd terraform
    - terraform init
    - |
      if [[ "$BRANCH" == "develop" ]]; then
        terraform workspace select nonprod
        chamber exec "$CHAMBER_NAMESPACE/nonprod" -- terraform apply -no-color -input=false -auto-approve -var-file=vars.nonprod.tfvars
      fi
    - |
      if [[ "$BRANCH" == "master" ]]; then
        terraform workspace select prod
        chamber exec "$CHAMBER_NAMESPACE/prod" -- terraform apply -no-color -input=false -auto-approve -var-file=vars.prod.tfvars
      fi
